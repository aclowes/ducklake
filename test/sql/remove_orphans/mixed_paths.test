# name: test/sql/remove_orphans/mixed_paths.test
# group: [remove_orphans]

require ducklake

require parquet

# partitioning based on a column
statement ok
ATTACH 'ducklake:__TEST_DIR__/mixed_paths.db' AS ducklake (DATA_PATH '__TEST_DIR__/mixed_paths', METADATA_CATALOG 'ducklake_metadata')

statement ok
USE ducklake

statement ok
CREATE TABLE test (a integer)

statement ok
insert into test values (1);

statement ok
CREATE TABLE test_2 (a integer)

statement ok
insert into test_2 values (1);

# Add orphaned file to both tables and to schema
statement ok
COPY test to '__TEST_DIR__/mixed_paths/main/test/bla.parquet';

# Add orphaned file to both tables and to schema
statement ok
COPY test to '__TEST_DIR__/mixed_paths/main/test_2/bla.parquet';

# Add orphaned file to both tables and to schema
statement ok
COPY test to '__TEST_DIR__/mixed_paths/main/bla.parquet';

query I
SELECT count(*) FROM ducklake_delete_orphaned_files('ducklake', cleanup_all => true, dry_run => true);
----
3

statement ok
CALL ducklake_add_data_files('ducklake', 'test', '__TEST_DIR__/mixed_paths/main/test/bla.parquet');

query I
SELECT count(*) FROM ducklake_delete_orphaned_files('ducklake', cleanup_all => true, dry_run => true);
----
2

statement ok
CALL ducklake_add_data_files('ducklake', 'test', '__TEST_DIR__/mixed_paths/main/test_2/bla.parquet');

query I
SELECT count(*) FROM ducklake_delete_orphaned_files('ducklake', cleanup_all => true, dry_run => true);
----
1

statement ok
CALL ducklake_add_data_files('ducklake', 'test_2', '__TEST_DIR__/mixed_paths/main/bla.parquet');

query I
SELECT count(*) FROM ducklake_delete_orphaned_files('ducklake', cleanup_all => true, dry_run => true);
----
0