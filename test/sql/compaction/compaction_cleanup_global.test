# name: test/sql/compaction/compaction_cleanup_global.test
# description: test ducklake cleanup using global setup
# group: [compaction]

require ducklake

require parquet

require icu

statement ok
ATTACH 'ducklake:__TEST_DIR__/compaction_cleanup_global.db' AS ducklake (DATA_PATH '__TEST_DIR__/compaction_cleanup_global', METADATA_CATALOG 'metadata')

statement ok
CREATE TABLE ducklake.test(i INTEGER)

statement ok
INSERT INTO ducklake.test FROM range(10)

statement ok
DELETE FROM ducklake.test

statement ok
DROP TABLE ducklake.test

statement ok
CALL ducklake_expire_snapshots('ducklake', dry_run => false, versions => [2])

statement ok
CALL ducklake.set_option('delete_older_than', '1 week')

# This should return 0 since file to be deleted is not that old
query I
SELECT count(*) FROM ducklake_cleanup_old_files('ducklake', dry_run => true);
----
0

statement ok
CALL ducklake.set_option('delete_older_than', '1 millisecond')

# This should return 1 since file to be deleted is older than 1 millisecond
query I
SELECT count(*) FROM ducklake_cleanup_old_files('ducklake', dry_run => true);
----
1
