# name: test/sql/compaction/cleanup_old_files_global_option.test
# description: Test global options for the cleanup old files function ducklake_cleanup_old_files
# group: [compaction]

require ducklake

require parquet

require icu

statement ok
ATTACH 'ducklake:__TEST_DIR__/cleanup_old_files_global_option.db' AS ducklake (DATA_PATH '__TEST_DIR__/cleanup_old_files_global_option')

# snapshot 1
statement ok
CREATE TABLE ducklake.test(i INTEGER)

# snapshot 2
statement ok
INSERT INTO ducklake.test FROM range(1000)

# snapshot 3
statement ok
DELETE FROM ducklake.test

# snapshot 4
statement ok
DROP TABLE ducklake.test

statement ok
CALL ducklake_expire_snapshots('ducklake', dry_run => false, versions => [2])

statement ok
CALL ducklake.set_option('delete_older_than', '1 millisecond')

query I
SELECT count(*) FROM ducklake_cleanup_old_files('ducklake', dry_run => true)
----
1

statement ok
CALL ducklake.set_option('delete_older_than', '1 week')

query I
SELECT count(*) FROM ducklake_cleanup_old_files('ducklake', dry_run => true)
----
0

query I
SELECT count(*) FROM ducklake_cleanup_old_files('ducklake', dry_run => true, cleanup_all => true)
----
1

