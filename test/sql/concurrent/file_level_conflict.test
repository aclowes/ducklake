# name: test/sql/concurrent/file_level_conflict.test
# description: test concurrent inserts
# group: [concurrent]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '__TEST_DIR__/concurrent_insert_conflict')

# statement ok
# SET ducklake_max_retry_count=0

statement ok
use ducklake;

statement ok
CREATE TABLE tbl (key INTEGER, grouping INTEGER);

statement ok
ALTER TABLE tbl SET PARTITIONED BY (grouping);

statement ok
insert into tbl select i as key, i%5 as grouping from range (0,1000) t(i);

concurrentloop i 0 5

statement ok
DELETE FROM ducklake.tbl WHERE key = ${i}

endloop

#
# query II
# SELECT COUNT(*), SUM(key) FROM ducklake.tbl
# ----
# 2	1
