# name: test/sql/geo/ducklake_geometry.test
# group: [geo]

require ducklake

require parquet

require spatial

statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake.db' AS ducklake (DATA_PATH '__TEST_DIR__/ducklake_files', METADATA_CATALOG 'ducklake_meta')

statement ok
USE ducklake;

statement ok
create table t1 (g GEOMETRY);

statement ok
insert into t1 VALUES (ST_POINT(1,2));

query I
select * from t1;
----
POINT (1 2)

# Inspect file stats
query I
select extra_stats from ducklake_meta.ducklake_file_column_stats;
----
{"bbox": {"xmin": 1.000000, "xmax": 1.000000, "ymin": 2.000000, "ymax": 2.000000, "zmin": null, "zmax": null, "mmin": null, "mmax": null}, "types": ["point"]}

query I
select extra_stats from ducklake_meta.ducklake_table_column_stats;
----
{"bbox": {"xmin": 1.000000, "xmax": 1.000000, "ymin": 2.000000, "ymax": 2.000000, "zmin": null, "zmax": null, "mmin": null, "mmax": null}, "types": ["point"]}

statement ok
insert into t1 VALUES ('LINESTRING Z (5 5 5, 10 10 10)'::GEOMETRY);

query I
select * from t1;
----
POINT (1 2)
LINESTRING Z (5 5 5, 10 10 10)

# Inspect file stats - should be separate for each file
query I
select extra_stats from ducklake_meta.ducklake_file_column_stats order by all;
----
{"bbox": {"xmin": 1.000000, "xmax": 1.000000, "ymin": 2.000000, "ymax": 2.000000, "zmin": null, "zmax": null, "mmin": null, "mmax": null}, "types": ["point"]}
{"bbox": {"xmin": 5.000000, "xmax": 10.000000, "ymin": 5.000000, "ymax": 10.000000, "zmin": 5.000000, "zmax": 10.000000, "mmin": null, "mmax": null}, "types": ["linestring_z"]}

# Check table stats are a union of the two files
query I
select extra_stats from ducklake_meta.ducklake_table_column_stats order by all;
----
{"bbox": {"xmin": 1.000000, "xmax": 10.000000, "ymin": 2.000000, "ymax": 10.000000, "zmin": 5.000000, "zmax": 10.000000, "mmin": null, "mmax": null}, "types": ["linestring_z", "point"]}

# Merge files into a single file and check stats remain the same
statement ok
CALL ducklake_merge_adjacent_files('ducklake')

query I
select extra_stats from ducklake_meta.ducklake_file_column_stats order by all;
----
{"bbox": {"xmin": 1.000000, "xmax": 10.000000, "ymin": 2.000000, "ymax": 10.000000, "zmin": 5.000000, "zmax": 10.000000, "mmin": null, "mmax": null}, "types": ["linestring_z", "point"]}

# Insert a geometry with M dimension
statement ok
insert into t1 VALUES ('POINT M (20 20 5)'::GEOMETRY);

# Insert a geometry with a ZM dimension
statement ok
insert into t1 VALUES ('POINT ZM (-30 -30 -30 -30)'::GEOMETRY);

query I
select * from t1 ORDER BY ALL;
----
POINT (1 2)
POINT M (20 20 5)
POINT ZM (-30 -30 -30 -30)
LINESTRING Z (5 5 5, 10 10 10)

# Check stats
query I
select extra_stats from ducklake_meta.ducklake_file_column_stats order by all;
----
{"bbox": {"xmin": -30.000000, "xmax": -30.000000, "ymin": -30.000000, "ymax": -30.000000, "zmin": -30.000000, "zmax": -30.000000, "mmin": -30.000000, "mmax": -30.000000}, "types": ["point_zm"]}
{"bbox": {"xmin": 1.000000, "xmax": 10.000000, "ymin": 2.000000, "ymax": 10.000000, "zmin": 5.000000, "zmax": 10.000000, "mmin": null, "mmax": null}, "types": ["linestring_z", "point"]}
{"bbox": {"xmin": 20.000000, "xmax": 20.000000, "ymin": 20.000000, "ymax": 20.000000, "zmin": null, "zmax": null, "mmin": 5.000000, "mmax": 5.000000}, "types": ["point_m"]}

# Now merge all again
statement ok
CALL ducklake_merge_adjacent_files('ducklake')

# Check merged stats
query I
select extra_stats from ducklake_meta.ducklake_file_column_stats order by all;
----
{"bbox": {"xmin": -30.000000, "xmax": 20.000000, "ymin": -30.000000, "ymax": 20.000000, "zmin": -30.000000, "zmax": 10.000000, "mmin": -30.000000, "mmax": 5.000000}, "types": ["linestring_z", "point", "point_m", "point_zm"]}
